#!/bin/bash

# Halt if virtualenv or pip are not installed
for command in virtualenv pip; do
	which $command &> /dev/null
	if [ $? -ne 0 ]; then
		echo -e "! Check if $command is installed";
		exit 1
	fi
done

# Halt if Python is not 2.7+
PYTHON_MAJOR_VERSION=$(python -c 'import sys; print sys.version_info.major')
if [[ $PYTHON_MAJOR_VERSION -ne 2 ]]; then
	echo -e "! This application won't run with Python 3 (yet)"
	exit 2
fi
PYTHON_MINOR_VERSION=$(python -c 'import sys; print sys.version_info.minor')
if [[ $PYTHON_MINOR_VERSION -lt 7 ]]; then
	echo -e "! You need Python 2.7+"
	exit 3
fi

# Create some folders and logfiles
mkdir -p logs uploads
touch logs/nginx.{access,error}.log

# Create a nice virtual environment
# If on RHEL, you'll need to compile Python 2.7 and use this instead:
#virtualenv -p /usr/bin/python2.7 .
virtualenv .
source ./bin/activate

# Install required modules
pip install -r requirements.txt

# Don't track a few files
echo -e "install" >> ./.gitignore
echo -e "scripts/run.sh" >> ./.gitignore
echo -e "settings.py" >> ./.gitignore

# Generate secret key
secret_key=$(openssl rand -base64 24)
echo -e "SECRET_KEY = \"$secret_key\"" >> settings.py

# Get the YUI compressor
mkdir misc && cd misc
wget https://github.com/downloads/yui/yuicompressor/yuicompressor-2.4.7.zip
unzip ./yuicompressor-2.4.7.zip
mv yuicompressor-2.4.7 yui
rm yuicompressor-2.4.7.zip
cd ..
